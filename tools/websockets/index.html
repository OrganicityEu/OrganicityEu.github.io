<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Websockets - Organicity Tech Docs</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">
                <img alt="Organicity Tech Docs" src="/images/oc_logo.png">OrganiCity Tech Docs
            </a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Architecture <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../AssetCRUD/">Asset CRUD</a>
</li>
                            
<li >
    <a href="../../AssetDataModel/">Asset Data Model</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Services <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../AssetDiscoveryService/">Asset Discovery Service</a>
</li>
                            
<li >
    <a href="../../annotations/AssetAnnotationService/">Asset Annotation Service</a>
</li>
                            
<li >
    <a href="../../ExperimenterPortal/">Experimenter Portal</a>
</li>
                            
<li >
    <a href="../../FederatedDataAssets/">Federated Data Assets</a>
</li>
                            
<li >
    <a href="../../UrbanDataObservatory/">Urban Data Observatory</a>
</li>
                            
<li >
    <a href="../../services/facility-manager/">Facility Manager</a>
</li>
                            
<li >
    <a href="../../services/community-management/">Community Management</a>
</li>
                            
<li >
    <a href="../../services/ReputationService/">Reputation Service</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../HowToAccessToken/">How To Access Token</a>
</li>
                            
<li >
    <a href="../../HowToAuthenticateAnUser/">How To Authenticate An User</a>
</li>
                            
<li >
    <a href="../../HowToOcSite/">How To Be An Oc Site</a>
</li>
                            
<li >
    <a href="../../HowToPushAnAsset/">How To Push An Asset</a>
</li>
                            
<li >
    <a href="../../HowToPushAnAssetToTheExperimenterSite/">How To Push An Asset To The Experimenter Site</a>
</li>
                            
<li >
    <a href="../../HowToPushAnAssetToTheProviderSite/">How To Push An Asset To The Provider Site</a>
</li>
                            
<li >
    <a href="../../HowToRefreshToken/">How To Refresh Token</a>
</li>
                            
<li >
    <a href="../../HowToUpdateDeteleAnAsset/">How To Update Detele An Asset</a>
</li>
                            
<li >
    <a href="../../annotations/tutorials/HowToCreateAnnotationTags/">How To Create Annotation Tags</a>
</li>
                            
<li >
    <a href="../../annotations/tutorials/HowToAnnotateAnAsset/">How To Annotate An Asset</a>
</li>
                            
<li >
    <a href="../../jamaica/tutorials/HowToAutomaticallyAnnotateAssets/">How To Annotate An Asset using Machine Learning</a>
</li>
                            
<li >
    <a href="../../OrganiCityTesterAPI/">OrganiCity API Tester Application</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tools <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../sensinact/">Eclipse sensiNact</a>
</li>
                            
<li >
    <a href="../tsmart/tsmart/">TSmart</a>
</li>
                            
<li >
    <a href="../set/">Smartphone Experimentation</a>
</li>
                            
<li class="active">
    <a href="./">Websockets</a>
</li>
                            
<li >
    <a href="../scenarios/">Scenarios</a>
</li>
                        </ul>
                    </li>
                
                  
                    <li><a href="/api/">APIS</a></li>
                  
                    <li><a href="https://status.organicity.eu/">Status</a></li>
                  
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../set/">
                            <i class="fa fa-arrow-left"></i>
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../scenarios/">
                            <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/organicityeu">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#websockets">Websockets</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#usage-example">Usage example</a></li>
            <li><a href="#technical-background">Technical background</a></li>
            <li><a href="#known-issues">Known issues</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="websockets">Websockets</h1>
<h2 id="introduction">Introduction</h2>
<p>This tool has been made available in order to provide real-time updates from assets in theOrganiCity platform. As an example, I might want to get a notification if the lights suddenly turns on in my office. By having e.g. a smartphone application that is using the websockets tool, it becomes possible to listen for updates coming directly from the office (provided that the office's light source is registerede as an asset in the OrganiCity platform). More generally, this tool creates a websocket client for connecting with the OrganiCity platform, and subscribe to updates on assets already registered on the platform.</p>
<h2 id="installation">Installation</h2>
<p>In order to make this tool work one would need to be working in a Java environment, and it is therefore a prerequisite that a java IDE is installed. Otherwise, the installation is quite simple.</p>
<ol>
<li>Go to this Github page and download the project as a zip file: https://github.com/OrganicityEu/WebsocketClient</li>
<li>Unzip the file locally</li>
<li>You can either open the entire websockets project as a maven project in your favourite java IDE or simply import WebsocketsClient/libs/WebsocketClient.jar as an external jar into your existing project</li>
</ol>
<p>That is it! In the following section, we will provide a concrete usage example on how to import the websocket tool as an external jar into a new java project.</p>
<h2 id="usage-example">Usage example</h2>
<p>This section provides a simple example on how to use the websocket tool, and we will be using Netbeans as the java IDE. The specific example shows how to subscribe to a single asset already created in the OrganiCity platform (it is not possible to subscribe to more than one asset at a time, and it is not possible to subscribe to creation or deletion of a new asset).</p>
<h3 id="start-netbeans-and-create-a-new-empty-java-project">Start Netbeans and create a new empty java project</h3>
<p>The below screenshots show the steps of creating a simple java application</p>
<p><img alt="Step_1" src="./images/step1.png" /></p>
<p><img alt="Step_2" src="./images/step2.png" /></p>
<p>When the java project has been created it is time to import the websocket connection</p>
<h3 id="add-websocketsclientjar-as-external-jar">Add WebsocketsClient.jar as external jar</h3>
<p>The below screenshots show how to add an external jar to an existing java project.</p>
<p>First you need to right-click on the "Libraries" folder and select "Add Jar/Folder..."</p>
<p><img alt="Step_3" src="./images/step3.png" /></p>
<p>Then you have to browse to where you unzipped the file from Github (see Installation section), select teh file named "WebsocketClient.jar", and finally click "Choose".</p>
<p><img alt="Step_4" src="./images/step4.png" /></p>
<p>That's it. The library has now been imported and can be leveraged in your project. In order to test the websocket functionality it is required to have an existing asset. If you don't have an existing asset, then read the next section. Otherwise, you can skip this section and jump directly to "Get authentication token".</p>
<h3 id="adding-an-asset-can-be-omitted-if-there-is-already-an-asset-available">Adding an asset (can be omitted if there is already an asset available)</h3>
<p>This task can only be performed if you are a registered OrganiCity experimenter! In order to become an experimenter go to this website https://experimenters.organicity.eu, and click "Sign in" (even if you don't have a user yet - you can create one).</p>
<p>You create a new asset by following this the steps in this link: http://docs.organicity.eu/HowToPushAnAssetToTheExperimenterSite/#tutorial-how-to-push-an-assets-to-the-organicity-experimenter-site</p>
<p>When the asset has been created, the next step is authentication.</p>
<h3 id="get-authentication-token">Get authentication token</h3>
<p>In order to be able to actually subscribe to a specific asset you need an anthentication token (a proof that you actually have the rights to get the information from the asset). This can be quite tricky, but we have created a tutorial on how to get the token: http://docs.organicity.eu/HowToAuthenticateAnUser/. You can either follow the steps directly from top to bottom or you can scroll all the way to the bottom of the tutorial and leverage existing libraries which might reduce some of your complexity.</p>
<p>When you have generated the authentication token it is time write some code.</p>
<h3 id="code-example">Code example</h3>
<p>Below is a code snippet showing how to subscribe to a specific asset. The specific code is not of any great use in a real setting, since it just performs a new subscription, and then deletes it five seconds later. The only purpose of the example is to show how to both subscribe and unsubscribe.</p>
<p>You can subscribe to an asset by using one of the following two constructors:</p>
<ul>
<li>The simple: public OrionSubscription(String entityId, String token)</li>
<li>The advanced: public OrionSubscription(String[] conditions, String[] attributes, String entityId, String token)</li>
</ul>
<p>A specific code example would be:</p>
<p><code>OrionSubscription subscription = new OrionSubscription("some_entity_id", "some_token_string");</code></p>
<p>Each of the parameters are described in the table below</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Value</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>conditions</td>
<td>Defines the "trigger" for the subscription</td>
<td>Need value</td>
<td>String[]</td>
</tr>
<tr>
<td>attributes</td>
<td>Define the "triggering attributes"</td>
<td>Need value</td>
<td>String[]</td>
</tr>
<tr>
<td>entityId</td>
<td>Id of the asset you want to subscribe to</td>
<td>Need value</td>
<td>String</td>
</tr>
<tr>
<td>token</td>
<td>The token accuired in the previous step</td>
<td>Need value</td>
<td>String</td>
</tr>
</tbody>
</table>
<p>Below is an example of a valid asset:</p>
<pre><code>{
  &quot;id&quot;: &quot;urn:oc:entity:experimenters:5a660d96-0ef7-42ca-9f6c-5dbb86d6aa20:58ab32f36f8b513746565c54:wsasset&quot;,
  &quot;type&quot;: &quot;urn:oc:entityType:userImage&quot;,
  &quot;TimeInstant&quot;: {
    &quot;type&quot;: &quot;urn:oc:attributeType:ISO8601&quot;,
    &quot;value&quot;: &quot;2016-10-04T13:45:00.000Z&quot;,
    &quot;metadata&quot;: {}
  },
  &quot;comments&quot;: {
    &quot;type&quot;: &quot;urn:oc:attributeType:text:string&quot;,
    &quot;value&quot;: &quot;hello&quot;,
    &quot;metadata&quot;: {}
  },
  &quot;user&quot;: {
    &quot;type&quot;: &quot;urn:oc:attributeType:text:string&quot;,
    &quot;value&quot;: &quot;world&quot;,
    &quot;metadata&quot;: {}
  }
}
</code></pre>

<p>And now the actual code :-)</p>
<pre><code>import java.util.List;
import dk.alexandra.orion.websocket.transports.OrionSubscription;
import websockets.WebsocketClientStomp;
import websockets.handlers.WebsocketCallback;

public class VanillaTestClient implements WebsocketCallback{

  WebsocketClientStomp wsc;
  long now;
  boolean hasSubscription = false;


  public VanillaTestClient(){
    now = System.currentTimeMillis();
    wsc= new WebsocketClientStomp(this, &quot;ws://31.200.243.76:8090/orion&quot;);
    startLoop();
  }

  private void startLoop(){
    while(true){
      if(System.currentTimeMillis()&gt;now+5000){
        if(!hasSubscription){
      /*
      Example of setting conditions and attributes. &quot;comments&quot; and &quot;user&quot; are taken
      from the example asset above. When using these, you will get a notifaction
      with user information, when the comment is altered (if &quot;hello&quot; is changed to
      something else)
      */
      String[] attr = new String[1];
      attr[0] = &quot;comments&quot;;
      String[] cond = new String[1];
      cond[0] = &quot;user&quot;;

      String entityId = &quot;&lt;Your asset id here here&gt;&quot;;
      String token = &quot;&lt;Your token here&gt;&quot;;

      //Example of subscribing to certain asset conditions and attributes
      //OrionSubscription subscription = new OrionSubscription(cond, attr, entityId, token);

      //Example of subscribing to a certain asset without any specific conditions
      OrionSubscription subscription = new OrionSubscription(entityId, token);

      System.out.println(&quot;trying to set subscrition&quot;);
      hasSubscription = wsc.registerSubscription(subscription);

          if(hasSubscription){
            System.out.println(&quot;subscription set&quot;);
          }  
        }else{
          List&lt;String&gt; subscriptions = wsc.getSubscriptions();
          if(subscriptions.size()&gt;0){
            if(wsc.unregisterSubscription(subscriptions.get(0))){
              hasSubscription=false;  
            }
          }
        }

        now = System.currentTimeMillis();
      }
    }
  }

  @Override
  public void messageReceived(String mesg) {
    System.out.println(&quot;Received message in Processing &quot;+mesg);
  }


  public static void main(String[] args){
    System.out.println(&quot;Starting Vanilla test client&quot;);
    VanillaTestClient client = new VanillaTestClient();
  }
}
</code></pre>

<p>If everything went as expected, then you have now made your first subscriptioon to the OrganiCity platform, and you are ready to make your application truely responsive to changes within OrganiCity.</p>
<h2 id="technical-background">Technical background</h2>
<p>The OrganiCity platform is built around the Orion Context Broker (https://fiware-orion.readthedocs.io/en/master/), and the websockets tool conform to the abilities and formats dictated by the context broker. As the Context Broker is REST based, we provide a Spring.io based middleware (https://github.com/OrganicityEu-Platform/WebsocketMiddleware) for transforming the connections between REST and Websockets.</p>
<p>For further technical and code detail, please take a look here: https://github.com/OrganicityEu/WebsocketClient</p>
<p>Technical reference to the Orion context brokers subscription feature: https://fiware-orion.readthedocs.io/en/develop/user/walkthrough_apiv2/index.html#subscriptions</p>
<p>Look there to acquire token: http://docs.organicity.eu/HowToAuthenticateAnUser/</p>
<h2 id="known-issues">Known issues</h2>
<p>When running the example code directly from within your IDE (e.g. Eclipse or Netbeans) it seems that the java process will not close down when stopping the application. It will only shut down properly if you run the application as debug. If you run the example from the commandline (as the final application outside of the IDE) then there should be no problems - it should all be working as expected, and all related java processe will clode down correctly.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p class="small">This project has received funding from the European Union's Horizon 2020 research and innovation program under the grant agreement No. 645198</p>
                  <img alt="This project has received funding from the European Union's Horizon 2020 research and innovation program under the grant agreement No. 645198" src="/images/logo_eu.png">            
            <p class="small">Last update 2017-07-06 07:47:52 built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../api/static/js/cropbox-min.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>